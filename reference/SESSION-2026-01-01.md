# Session Notes - 2026-01-01

## Summary
Implemented client-side PDF citation highlighting using pdf.js text layer. This works for most citations but has some edge cases that need investigation.

## What Was Done

### Problem
- Clicking on citations in the findings panel should highlight the quoted text in the PDF
- The yellow highlight wasn't appearing
- Root cause: **100% of citations had null bbox values** in the database
- Layout Parser (Document AI) doesn't provide bounding box coordinates

### Solution Implemented
Instead of relying on server-side bbox coordinates, we implemented client-side text search:

1. **Enabled pdf.js text layer** - renders invisible selectable text over PDF
2. **Added `searchText` prop** to PdfViewer component
3. **Text matching algorithm**:
   - Normalize both quote_text and page text (whitespace, quotes, dashes)
   - Search for match in normalized text
   - If no match, try partial matching (80%, 60%, 40% of quote)
4. **Highlight matching spans** with yellow background
5. **Auto-scroll** to first highlighted element

### Files Changed
- `src/components/document/PdfViewer.tsx` - Added text layer + search/highlight logic
- `src/app/document/[id]/page.tsx` - Pass `quote_text` as `searchText` prop
- `scripts/check-bbox.ts` - Database diagnostic script (created)
- `reference/.gitignore` - Ignore JSON files in reference folder

### Commits
- `4b2f916` - feat: Client-side text search highlighting for PDF citations

## Current State
- **Working**: Most citations highlight correctly when clicked
- **Not Working**: Some citations don't highlight (edge cases)

## Next Steps (Tomorrow)

### Investigate Non-Highlighting Citations
1. Open browser console and look for `[PdfViewer]` logs when clicking citations
2. Check for:
   - "Text layer not found" - timing issue, need longer delay
   - "No text spans found" - page rendering issue
   - "No text match found" - text normalization or OCR differences
   - "Partial match found" - working but with truncated match

### Potential Fixes to Try
1. **Longer delay before searching** - currently 150ms, try 300ms
2. **Better normalization** - add more character replacements
3. **Smaller partial match threshold** - try 30%, 20%
4. **Word-by-word matching** - for heavily OCR'd documents
5. **Debug specific failing citations** - compare `quote_text` vs page text

### How to Debug
```javascript
// In browser console on document page:
// Click a citation that doesn't highlight
// Look for these logs:
[PdfViewer] Text layer not found
[PdfViewer] No text spans found in layer
[PdfViewer] No text match found for: "quote text here..."
[PdfViewer] Text match found at position: 123
[PdfViewer] Partial match found (80/100 chars)
```

### Database Check Script
```bash
# Check citation bbox status
npx tsx scripts/check-bbox.ts
```

## Key Code Locations

### PdfViewer Component
`src/components/document/PdfViewer.tsx`
- Lines 60-70: `normalizeText` function
- Lines 72-141: `highlightTextInLayer` function
- Lines 143-159: `highlightSpansInRange` helper
- Lines 176-183: Effect that triggers highlighting

### Document Page
`src/app/document/[id]/page.tsx`
- Line 390: Passes `searchText` to PdfViewer

## Architecture Decision
See `reference/DECISIONS.md` for full ADR on "Client-Side PDF Text Highlighting"

Key rationale:
- Layout Parser doesn't provide bbox (intelligent extraction but no coordinates)
- OCR processor provides bbox but less intelligent extraction
- User explicitly wanted to keep Layout Parser's intelligence
- Client-side search is zero additional API cost

## Notes for Future Sessions
- The `bbox` column in citations table is now effectively unused
- Could consider removing bbox storage entirely or repurposing it
- The text layer approach could be extended to support:
  - Multiple highlight colors for different findings
  - Text selection for new citation creation
  - Search across entire document
